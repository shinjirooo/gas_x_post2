## 目的
`GX` 名前空間配下の `GX.Auth`（認証/トークン更新/HTTPラッパ）と `GX.Follow`（ユーザー取得/フォロー関係判定）の使い方をまとめます。別プロジェクトへコピペした直後に参照できるハンズオンです。

## 導入手順
1) ファイル追加（GAS プロジェクトにコピペ）
   - `src/gx_auth.js`
   - `src/gx_follow.js`
   - 読み込み順はファイル名の昇順です。`gx_auth.js` → `gx_follow.js` の順で読み込まれるため依存関係は満たされます。

2) コールバック委譲の `doGet` を定義
```javascript
function doGet(e) { return GX.Auth.handleOAuthCallback(e); }
```

3) スクリプトプロパティ設定（Apps Script > サービス > プロパティ）
- 以下のキーを設定してください（推奨は新キー）。
  - `GX_AUTH_CLIENT_ID`（必須）
  - `GX_AUTH_CLIENT_SECRET`（必須）
  - `GX_AUTH_REDIRECT_URI`（必須：ウェブアプリのURL）
- 互換のため旧キー（`CLIENT_ID`, `CLIENT_SECRET`, `REDIRECT_URI`）も参照しますが、将来は新キーへ統一してください。

4) 既存プロパティからの移行（任意）
```javascript
// 一度だけ実行
function migrate() { GX.Auth.migrateProperties(); }
```

## 認証フローの使い方（GX.Auth）
- **未認証の場合の認証URL提示**
```javascript
function showAuthUrl() {
  if (!GX.Auth.hasAccess()) {
    Logger.log('下記URLで認証してください:');
    Logger.log(GX.Auth.getAuthorizationUrl());
    return;
  }
  Logger.log('すでに認証済みです');
}
```

- **コールバックの受け取り**
  - ウェブアプリにデプロイし、`doGet(e)` が `GX.Auth.handleOAuthCallback(e)` に委譲されていることを確認してください。認証後にアクセストークン/リフレッシュトークンがプロパティに保存されます。

- **デバッグログの出力**
```javascript
function enableDebug() { GX.Auth.setDebug(true); }
```

## API 呼び出しの使い方（GX.Auth.call）
`GX.Auth.call(method, url, headers?, payload?)` を使って Bearer 付きでエンドポイントを呼び出します。401 の場合は自動でリフレッシュ→再試行します。

```javascript
function getMyAccount() {
  if (!GX.Auth.hasAccess()) {
    Logger.log(GX.Auth.getAuthorizationUrl());
    return;
  }
  var url = GX.Auth.API_BASE_URL + '/users/me?user.fields=id,name,username';
  var me = GX.Auth.call('GET', url, {}, undefined);
  Logger.log(JSON.stringify(me, null, 2));
}
```

注: このプロジェクトは読み取り専用のため、POSTのサンプルは記載しません。

## フォロー関係チェック（GX.Follow）
- **単一ユーザーの関係判定**
```javascript
function checkOne() {
  if (!GX.Auth.hasAccess()) return;
  var result = GX.Follow.checkUserFollowsMe('0125ss25'); // 先頭の@は不要
  Logger.log(JSON.stringify(result, null, 2));
}
```

- **複数ユーザーのまとめ判定**
```javascript
function checkMany() {
  if (!GX.Auth.hasAccess()) return;
  var targets = ['0125ss25', 'mmr_ars'];
  var results = GX.Follow.checkRelations(targets);
  Logger.log(JSON.stringify(results, null, 2));
}
```

- **ユーザー情報の取得（connection_status 付き）**
```javascript
function getUser() {
  if (!GX.Auth.hasAccess()) return;
  var user = GX.Follow.getUserByUsername('jack');
  Logger.log(JSON.stringify(user, null, 2));
}
```

## よくある注意点
- **`doGet` はプロジェクト内で1つだけ**: 既存の `doGet` がある場合は `GX.Auth.handleOAuthCallback(e)` を中で呼び出すよう統合してください。
- **ファイル読み込み順**: GAS はファイル名の昇順で読み込みます。`gx_auth.js` が `gx_follow.js` より先に読み込まれることを確認してください（現行名でOK）。
- **旧コードとの重複に注意**: 既存のグローバル関数名/定数と衝突する場合があります。移行期間は旧コード側の公開関数呼び出しを停止するか、ファイル名で読み込み順を制御してください。
- **プロパティキーは新キーへ**: 新規プロジェクトでは `GX_AUTH_*` 系キーで統一を推奨します。

## 最小動作サンプル
```javascript
function example() {
  if (!GX.Auth.hasAccess()) {
    Logger.log('Authorize:');
    Logger.log(GX.Auth.getAuthorizationUrl());
    return;
  }
  var result = GX.Follow.checkUserFollowsMe('0125ss25');
  Logger.log(JSON.stringify(result, null, 2));
}
```


